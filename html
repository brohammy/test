import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously } from 'firebase/auth';
import { getFirestore, doc, setDoc, collection, onSnapshot, query, deleteDoc } from 'firebase/firestore';
import { getStorage, ref, uploadBytes, deleteObject } from 'firebase/storage';

const App = () => {
    // State variables for the application
    const [loading, setLoading] = useState(true);
    const [user, setUser] = useState(null);
    const [uploadedFiles, setUploadedFiles] = useState([]);
    const [totalSize, setTotalSize] = useState(0);
    const [formState, setFormState] = useState({
        ipaFile: null,
        p12File: null,
        provFile: null,
        p12Password: '',
        appName: '',
        bundleId: '',
        entitlements: ''
    });
    const [signingStatus, setSigningStatus] = useState({
        progress: 0,
        message: 'Waiting for files...',
        isSigning: false,
    });
    const [result, setResult] = useState(null);
    const [error, setError] = useState(null);

    // References for Firebase services
    const dbRef = useRef(null);
    const authRef = useRef(null);
    const storageRef = useRef(null);

    // Constants
    const GIGABYTE_LIMIT = 1024 * 1024 * 1024; // 1 GB in bytes

    // Firebase Initialization and Authentication
    useEffect(() => {
        const initFirebase = async () => {
            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const app = initializeApp(firebaseConfig);
                authRef.current = getAuth(app);
                dbRef.current = getFirestore(app);
                storageRef.current = getStorage(app);

                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(authRef.current, initialAuthToken);
                } else {
                    await signInAnonymously(authRef.current);
                }

                const unsubscribeAuth = authRef.current.onAuthStateChanged((currentUser) => {
                    setUser(currentUser);
                    setLoading(false);
                });
                return () => unsubscribeAuth();
            } catch (err) {
                console.error("Firebase initialization failed:", err);
                setError("Failed to initialize the app. Please try again later.");
                setLoading(false);
            }
        };

        initFirebase();
    }, []);

    // Firestore Listener for User Files
    useEffect(() => {
        if (!user || !dbRef.current) return;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const userId = user.uid;

        const filesCollectionRef = collection(dbRef.current, `artifacts/${appId}/users/${userId}/uploaded_files`);
        const q = query(filesCollectionRef);

        const unsubscribeFirestore = onSnapshot(q, (snapshot) => {
            let currentSize = 0;
            const files = snapshot.docs.map(doc => {
                const data = doc.data();
                currentSize += data.size || 0;
                return { id: doc.id, ...data };
            });
            setUploadedFiles(files);
            setTotalSize(currentSize);
        }, (err) => {
            console.error("Firestore listen failed:", err);
            setError("Failed to load your files. Please check your connection.");
        });

        return () => unsubscribeFirestore();
    }, [user]);

    // File input change handler
    const handleFileChange = (e, fileType) => {
        const file = e.target.files[0];
        setFormState(prev => ({ ...prev, [fileType]: file }));
    };

    // Form input change handler
    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setFormState(prev => ({ ...prev, [name]: value }));
    };

    // Upload a file to Firebase Storage and add metadata to Firestore
    const uploadFile = async (file, fileType) => {
        if (!file) return;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const userId = user.uid;
        // The path is constructed to follow the security rules.
        const storagePath = `artifacts/${appId}/users/${userId}/${file.name}`;

        try {
            // NOTE: Due to permissions issues, we are simulating the file upload.
            // In a real-world scenario, you would uncomment the line below.
            // const fileRef = ref(storageRef.current, storagePath);
            // await uploadBytes(fileRef, file);
            console.warn(`Simulating upload of ${file.name}. Actual file not stored due to permissions.`);

            // Add file metadata to Firestore
            const fileDocRef = doc(dbRef.current, `artifacts/${appId}/users/${userId}/uploaded_files/${fileType}`);
            await setDoc(fileDocRef, {
                name: file.name,
                size: file.size,
                type: file.type,
                storagePath: storagePath,
                uploadedAt: new Date(),
            });

            return true;
        } catch (e) {
            console.error("Upload failed:", e);
            setError(`Failed to upload ${fileType}. Please try again.`);
            return false;
        }
    };

    // Form submission handler
    const handleSubmit = async (e) => {
        e.preventDefault();
        setError(null);
        setSigningStatus({ ...signingStatus, isSigning: true });

        const { ipaFile, p12File, provFile, p12Password } = formState;

        if (!p12Password.trim()) {
            setError("Please enter a password before signing.");
            setSigningStatus({ ...signingStatus, isSigning: false });
            return;
        }

        const newTotalSize = totalSize + (ipaFile?.size || 0) + (p12File?.size || 0) + (provFile?.size || 0);
        if (newTotalSize > GIGABYTE_LIMIT) {
            setError('Total file size exceeds the 1 GB limit. Please remove old files or upload smaller files.');
            setSigningStatus({ ...signingStatus, isSigning: false });
            return;
        }
        
        // Simulate file uploads
        const uploadPromises = [
            uploadFile(ipaFile, 'ipaFile'),
            uploadFile(p12File, 'p12File'),
            uploadFile(provFile, 'provFile'),
        ];
        
        const uploadResults = await Promise.all(uploadPromises);
        if (uploadResults.includes(false)) {
            setSigningStatus({ ...signingStatus, isSigning: false });
            return;
        }

        // Simulate the signing process
        simulateSigningProcess();
    };

    // Simulates the signing process with progress updates
    const simulateSigningProcess = () => {
        const steps = [
            { percent: 25, message: 'Validating certificates and provisioning profile...' },
            { percent: 50, message: 'Re-signing the application bundle...' },
            { percent: 75, message: 'Compressing and preparing for download...' },
            { percent: 100, message: 'Signing complete!' }
        ];

        let stepIndex = 0;
        const intervalId = setInterval(() => {
            if (stepIndex < steps.length) {
                const step = steps[stepIndex];
                setSigningStatus({
                    ...signingStatus,
                    progress: step.percent,
                    message: step.message
                });
                stepIndex++;
            } else {
                clearInterval(intervalId);
                setResult({
                    bundleName: formState.appName || 'Mock App',
                    bundleId: formState.bundleId || 'com.mock.app',
                    bundleVersion: '1.0.0',
                    signedIpaUrl: '#',
                    installLink: '#'
                });
                setSigningStatus({ ...signingStatus, isSigning: false });
            }
        }, 1000);
    };
    
    // Function to format file size
    const formatBytes = (bytes, decimals = 2) => {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    };

    // Function to reset the form state
    const resetForm = () => {
        setFormState({
            ipaFile: null,
            p12File: null,
            provFile: null,
            p12Password: '',
            appName: '',
            bundleId: '',
            entitlements: ''
        });
        setResult(null);
        setError(null);
        setSigningStatus({
            progress: 0,
            message: 'Waiting for files...',
            isSigning: false,
        });
    };

    // Function to delete an uploaded file
    const deleteFile = async (fileId, storagePath) => {
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const userId = user.uid;

        try {
            // NOTE: Since the file was not uploaded to Storage, we don't need to delete it.
            // In a real-world scenario, you would uncomment the line below.
            // const fileRef = ref(storageRef.current, storagePath);
            // await deleteObject(fileRef);
            console.warn(`Simulating delete of file metadata. Actual file not deleted as it was not stored.`);

            const docRef = doc(dbRef.current, `artifacts/${appId}/users/${userId}/uploaded_files/${fileId}`);
            await deleteDoc(docRef);
        } catch (e) {
            console.error("Delete failed:", e);
            setError("Failed to delete the file. Please try again.");
        }
    };

    // Helper function to check if form is valid
    const isFormValid = () => {
        const { ipaFile, p12File, provFile, p12Password } = formState;
        return ipaFile && p12File && provFile && p12Password.trim() !== '';
    };

    // Loading state UI
    if (loading) {
        return (
            <div className="bg-gray-100 min-h-screen flex items-center justify-center">
                <div className="text-gray-700 text-lg">Initializing app and authenticating...</div>
            </div>
        );
    }

    return (
        <div className="min-h-screen flex items-center justify-center p-5 bg-gradient-to-br from-blue-400 to-indigo-900">
            <div className="max-w-4xl w-full bg-white bg-opacity-90 backdrop-filter backdrop-blur-lg rounded-3xl shadow-2xl p-8 space-y-8 border border-white border-opacity-30">
                <div className="text-center">
                    <h1 className="text-5xl font-extrabold text-gray-800">Advanced IPA Signer</h1>
                    <p className="mt-2 text-xl text-gray-600">Securely sign and manage your iOS apps.</p>
                </div>

                <div className="bg-blue-50 border-l-4 border-blue-400 text-blue-800 p-4 rounded-lg shadow-inner">
                    <div className="flex items-center">
                        <svg className="w-6 h-6 mr-3 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd"></path>
                        </svg>
                        <p className="text-sm font-medium">
                            <strong>User ID:</strong> <span className="font-mono break-all">{user?.uid}</span>
                        </p>
                    </div>
                    <p className="text-sm font-medium mt-2 ml-9">
                        <strong>Storage Used:</strong> {formatBytes(totalSize)} / {formatBytes(GIGABYTE_LIMIT)}
                    </p>
                </div>

                {error && (
                    <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
                        <span className="block sm:inline">{error}</span>
                    </div>
                )}

                {result && (
                    <div className="fade-in mt-8 text-center">
                        <h3 className="text-3xl font-bold text-green-600 mb-4">
                            <svg className="h-8 w-8 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Signing Complete!
                        </h3>
                        <div className="space-y-3 text-left p-6 bg-gray-50 rounded-lg">
                            <p className="text-gray-700 font-semibold">App Name: <span className="font-normal text-gray-900">{result.bundleName}</span></p>
                            <p className="text-gray-700 font-semibold">Bundle ID: <span className="font-normal text-gray-900">{result.bundleId}</span></p>
                            <p className="text-gray-700 font-semibold">Version: <span className="font-normal text-gray-900">{result.bundleVersion}</span></p>
                        </div>
                        <div className="mt-6 flex flex-col sm:flex-row justify-center gap-4">
                            <a href={result.signedIpaUrl} className="bg-blue-600 text-white font-bold py-3 px-6 rounded-full transition-transform transform hover:scale-105 shadow-md hover:shadow-lg">
                                Download Signed IPA
                            </a>
                            <a href={result.installLink} className="bg-green-600 text-white font-bold py-3 px-6 rounded-full transition-transform transform hover:scale-105 shadow-md hover:shadow-lg">
                                Install via OTA
                            </a>
                        </div>
                        <div className="mt-4 text-center">
                            <button onClick={resetForm} className="text-blue-500 hover:text-blue-700 transition-colors duration-200">Sign another IPA</button>
                        </div>
                    </div>
                )}

                {signingStatus.isSigning ? (
                    <div className="mt-8 text-center fade-in">
                        <h3 className="text-2xl font-bold text-gray-800 mb-4">Signing In Progress...</h3>
                        <div className="w-full bg-gray-200 rounded-full h-4">
                            <div className="bg-gradient-to-r from-blue-400 to-blue-600 h-4 rounded-full" style={{ width: `${signingStatus.progress}%` }}></div>
                        </div>
                        <p className="mt-2 text-gray-600">{signingStatus.message}</p>
                    </div>
                ) : (
                    !result && (
                        <form onSubmit={handleSubmit} className="space-y-8">
                            <section className="space-y-4">
                                <h2 className="text-2xl font-bold text-gray-800">1. Upload Files</h2>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    {/* IPA File Upload */}
                                    <div>
                                        <label className="block text-gray-700 font-semibold mb-2">IPA File</label>
                                        <div className="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center cursor-pointer transition-colors hover:bg-gray-100" onClick={() => document.getElementById('ipaFile').click()}>
                                            <svg className="w-12 h-12 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                            </svg>
                                            <p className="mt-2 text-sm text-gray-600">Drag & drop or click to browse</p>
                                            <input type="file" id="ipaFile" name="ipaFile" accept=".ipa" className="hidden" onChange={(e) => handleFileChange(e, 'ipaFile')} />
                                            <p className="mt-2 text-sm font-medium text-gray-800">{formState.ipaFile ? `${formState.ipaFile.name}` : ''}</p>
                                        </div>
                                    </div>
                                    {/* P12 File Upload */}
                                    <div>
                                        <label className="block text-gray-700 font-semibold mb-2">P12 Certificate</label>
                                        <div className="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center cursor-pointer transition-colors hover:bg-gray-100" onClick={() => document.getElementById('p12File').click()}>
                                            <svg className="w-12 h-12 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 7a2 2 0 012 2v2m0 0v2m0-2h2m-2 0h-2m-2 2a2 2 0 01-2 2h-2a2 2 0 01-2-2V9a2 2 0 012-2h2a2 2 0 012 2v2zm-4 4h.01" />
                                            </svg>
                                            <p className="mt-2 text-sm text-gray-600">Drag & drop or click to browse</p>
                                            <input type="file" id="p12File" name="p12File" accept=".p12" className="hidden" onChange={(e) => handleFileChange(e, 'p12File')} />
                                            <p className="mt-2 text-sm font-medium text-gray-800">{formState.p12File ? `${formState.p12File.name}` : ''}</p>
                                        </div>
                                    </div>
                                    {/* Provisioning Profile Upload */}
                                    <div>
                                        <label className="block text-gray-700 font-semibold mb-2">Provisioning Profile</label>
                                        <div className="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center cursor-pointer transition-colors hover:bg-gray-100" onClick={() => document.getElementById('provFile').click()}>
                                            <svg className="w-12 h-12 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            <p className="mt-2 text-sm text-gray-600">Drag & drop or click to browse</p>
                                            <input type="file" id="provFile" name="provFile" accept=".mobileprovision" className="hidden" onChange={(e) => handleFileChange(e, 'provFile')} />
                                            <p className="mt-2 text-sm font-medium text-gray-800">{formState.provFile ? `${formState.provFile.name}` : ''}</p>
                                        </div>
                                    </div>
                                </div>
                            </section>

                            <section className="space-y-4">
                                <h2 className="text-2xl font-bold text-gray-800">2. P12 Certificate Password</h2>
                                <label htmlFor="p12Password" className="block text-sm font-medium text-gray-700">Please enter the password for your P12 certificate to enable the signing process.</label>
                                <input
                                    type="password"
                                    id="p12Password"
                                    name="p12Password"
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                    value={formState.p12Password}
                                    onChange={handleInputChange}
                                    required
                                />
                            </section>

                            <section className="space-y-4">
                                <h2 className="text-2xl font-bold text-gray-800">3. Advanced Options (Optional)</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label htmlFor="bundleId" className="block text-sm font-medium text-gray-700">New Bundle ID</label>
                                        <input
                                            type="text"
                                            id="bundleId"
                                            name="bundleId"
                                            className="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                            value={formState.bundleId}
                                            onChange={handleInputChange}
                                            placeholder="com.example.newapp"
                                        />
                                    </div>
                                    <div>
                                        <label htmlFor="appName" className="block text-sm font-medium text-gray-700">New App Name</label>
                                        <input
                                            type="text"
                                            id="appName"
                                            name="appName"
                                            className="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                            value={formState.appName}
                                            onChange={handleInputChange}
                                            placeholder="My New App"
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label htmlFor="entitlements" className="block text-sm font-medium text-gray-700">Entitlements (JSON format)</label>
                                    <textarea
                                        id="entitlements"
                                        name="entitlements"
                                        rows="4"
                                        className="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                        value={formState.entitlements}
                                        onChange={handleInputChange}
                                        placeholder='{ "keychain-access-groups": ["group.com.example.app"] }'
                                    ></textarea>
                                </div>
                            </section>

                            {uploadedFiles.length > 0 && (
                                <section className="space-y-4">
                                    <h2 className="text-2xl font-bold text-gray-800">Your Uploaded Files</h2>
                                    <ul className="space-y-3">
                                        {uploadedFiles.map(file => (
                                            <li key={file.id} className="flex items-center justify-between bg-gray-50 p-4 rounded-xl shadow-sm">
                                                <span className="flex items-center text-gray-700">
                                                    <svg className="w-5 h-5 mr-2 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M10 2a8 8 0 100 16 8 8 0 000-16zM8.07 15.82a.5.5 0 01-.1-.7L12.7 9.5a.5.5 0 01.7.1l4.7 5.61a.5.5 0 01-.1.7l-4.7 5.61a.5.5 0 01-.7-.1l-4.7-5.61z" />
                                                    </svg>
                                                    <span className="truncate">{file.name}</span>
                                                    <span className="ml-2 text-sm text-gray-500">({formatBytes(file.size)})</span>
                                                </span>
                                                <button type="button" onClick={() => deleteFile(file.id, file.storagePath)} className="text-red-500 hover:text-red-700 transition-colors">
                                                    <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                    </svg>
                                                </button>
                                            </li>
                                        ))}
                                    </ul>
                                </section>
                            )}
                            
                            <div className="text-center">
                                <button
                                    type="submit"
                                    className={`w-full py-4 rounded-full font-extrabold text-xl text-white transition-all transform hover:scale-105 shadow-lg ${isFormValid() ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-gray-400 cursor-not-allowed'}`}
                                    disabled={!isFormValid()}
                                >
                                    Start Signing Process
                                </button>
                            </div>
                        </form>
                    )
                )}
            </div>
        </div>
    );
};

export default App;
